<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmos Wallpaper</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            background: #000;
        }
        
        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';

        // Wallpaper Engine properties (if available)
        const wallpaperProperties = window.wallpaperPropertyListener || {};
        let rotationSpeed = 0.0001;
        let starCount = 8000; // More stars for ultrawide
        let starSize = 1.5;
        
        // Listen for Wallpaper Engine property changes
        if (window.wallpaperPropertyListener) {
            window.wallpaperPropertyListener = {
                applyUserProperties: function(properties) {
                    if (properties.rotationspeed) {
                        rotationSpeed = properties.rotationspeed.value * 0.0001;
                    }
                    if (properties.starcount) {
                        starCount = properties.starcount.value;
                    }
                    if (properties.starsize) {
                        starSize = properties.starsize.value;
                    }
                }
            };
        }

        // Star catalog generator optimized for ultrawide
        function generateStarCatalog(count = 8000) {
            const stars = [];
            const spectralColors = {
                'O': 0x9bb0ff,
                'B': 0xaabfff,
                'A': 0xcad7ff,
                'F': 0xf8f7ff,
                'G': 0xfff4ea,
                'K': 0xffd2a1,
                'M': 0xffcc6f
            };
            
            const distribution = [
                { type: 'O', weight: 0.00003 },
                { type: 'B', weight: 0.13 },
                { type: 'A', weight: 0.6 },
                { type: 'F', weight: 3 },
                { type: 'G', weight: 7.6 },
                { type: 'K', weight: 12.1 },
                { type: 'M', weight: 76.45 }
            ];
            
            for (let i = 0; i < count; i++) {
                const rand = Math.random() * 100;
                let cumulative = 0;
                let spectralType = 'M';
                
                for (const { type, weight } of distribution) {
                    cumulative += weight;
                    if (rand < cumulative) {
                        spectralType = type;
                        break;
                    }
                }
                
                // Wider distribution for ultrawide monitors
                const radius = Math.pow(Math.random(), 0.3) * 600 + 100;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                
                const x = radius * Math.sin(phi) * Math.cos(theta);
                const y = radius * Math.sin(phi) * Math.sin(theta);
                const z = radius * Math.cos(phi);
                
                const magnitude = -1.5 + Math.random() * 8;
                const brightness = Math.pow(10, -magnitude / 2.5);
                
                stars.push({
                    x, y, z,
                    color: spectralColors[spectralType],
                    brightness: Math.max(0.3, Math.min(brightness * 2, 3))
                });
            }
            
            return stars;
        }

        // Scene setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(
            75, // Wider FOV for ultrawide
            window.innerWidth / window.innerHeight,
            0.1,
            10000
        );
        
        const renderer = new THREE.WebGLRenderer({ 
            antialias: true, 
            alpha: false,
            powerPreference: "high-performance"
        });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limit for performance
        document.body.appendChild(renderer.domElement);
        
        camera.position.set(0, 0, 600);
        
        // Generate stars
        const starData = generateStarCatalog(starCount);
        
        // Create particle system
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(starData.length * 3);
        const colors = new Float32Array(starData.length * 3);
        const sizes = new Float32Array(starData.length);
        
        starData.forEach((star, i) => {
            positions[i * 3] = star.x;
            positions[i * 3 + 1] = star.y;
            positions[i * 3 + 2] = star.z;
            
            const color = new THREE.Color(star.color);
            colors[i * 3] = color.r;
            colors[i * 3 + 1] = color.g;
            colors[i * 3 + 2] = color.b;
            
            sizes[i] = star.brightness * starSize;
        });
        
        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
        
        // Star texture
        const canvas = document.createElement('canvas');
        canvas.width = 32;
        canvas.height = 32;
        const ctx = canvas.getContext('2d');
        
        const gradient = ctx.createRadialGradient(16, 16, 0, 16, 16, 16);
        gradient.addColorStop(0, 'rgba(255,255,255,1)');
        gradient.addColorStop(0.2, 'rgba(255,255,255,1)');
        gradient.addColorStop(0.4, 'rgba(255,255,255,0.5)');
        gradient.addColorStop(1, 'rgba(255,255,255,0)');
        
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 32, 32);
        
        const starTexture = new THREE.CanvasTexture(canvas);
        
        // Material
        const material = new THREE.PointsMaterial({
            size: 2,
            map: starTexture,
            vertexColors: true,
            blending: THREE.AdditiveBlending,
            transparent: true,
            depthTest: true,
            depthWrite: false,
            sizeAttenuation: true
        });
        
        const starField = new THREE.Points(geometry, material);
        scene.add(starField);
        
        // Smooth rotation
        let rotation = { x: 0.1, y: 0 };
        
        // Animation
        function animate() {
            requestAnimationFrame(animate);
            
            // Gentle continuous rotation
            rotation.y += rotationSpeed;
            rotation.x = 0.1 + Math.sin(Date.now() * 0.00005) * 0.05;
            
            starField.rotation.x = rotation.x;
            starField.rotation.y = rotation.y;
            
            renderer.render(scene, camera);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
        
        animate();
    </script>
</body>
</html>
